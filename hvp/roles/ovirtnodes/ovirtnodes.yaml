---
# Ansible playbook to initialize oVirt nodes and install oVirt Self Hosted Engine
# Note: oVirt Hosted Engine installation will be performed on the node selected as master above
# Note: we assume that libvirt lists the CPU models in an ordered sequence of increasing available features (apart from appending AMD models to Intel ones)
- name: Generate SSH key if not present
  hosts: localhost
  tasks:
    - include_tasks: ../common/tasks/createkeys.yaml
- name: Gather CPU type across all hosts
  hosts: ovirtnodes
  remote_user: root
  tasks:
    - include_tasks: ../common/tasks/setupkeys.yaml
    - name: Gather CPU types
      hvp_cpu_type:
- name: Check CPU facts cluster-wide
  hosts: localhost
  tasks:
    - name: Make sure that the CPU vendor is homogeneous
      assert: { that: "hostvars['{{ item }}']['hvp_cpu_type']['vendor'] == hostvars[groups['ovirt_master'][0]]['hvp_cpu_type']['vendor']", msg: "CPU vendor must be the same across all hosts" }
      with_items: "{{ groups['ovirt_nonmaster_nodes'] }}"
    - name: Define common CPU index
      set_fact:
        cpu_index: "{{ groups['ovirtnodes'] | map('extract', hostvars, ['hvp_cpu_type', 'index']) | list | sort | min }}"
    - name: Define common CPU model
      set_fact:
        cpu_type: "model_{{ groups['ovirtnodes'] | map('extract', hostvars, 'hvp_cpu_type') | list | json_query(\"[?index == '\" + cpu_index + \"'].model\") | first }}"
- name: Perform oVirt nodes configuration
  hosts: ovirtnodes
  remote_user: root
  tasks:
    - name: Define traditional ethernet facts
      # Note: eth interfaces enumeration taken from https://serverfault.com/a/852093
      set_fact:
        ansible_eth: "{% set ansible_eth = ansible_eth|default([]) + [hostvars[inventory_hostname]['ansible_' + item]] %}{{ ansible_eth|list }}"
      when: (hostvars[inventory_hostname]['ansible_' + item]['type'] == 'ether') or (hostvars[inventory_hostname]['ansible_' + item]['type'] == 'bonding')
      with_items:
        - "{{ hostvars[inventory_hostname]['ansible_interfaces'] }}"
    - name: Reset VDSM configuration
      command: vdsm-tool configure --force
      register: vdsm_result
- name: Perform oVirt Hosted Engine setup
  hosts: ovirt_master
  remote_user: root
  tasks:
    - name: Get common vars
      include_vars:
        file: ../common/vars/hvp.yaml
    - name: Generate random MAC address for Engine appliance
      shell: echo 'from ovirt_hosted_engine_setup import util as ohostedutil; print ohostedutil.randomMAC()' | python
      register: mac_result
    - name: Get Engine appliance ova filename
      shell: echo /usr/share/ovirt-engine-appliance/ovirt-engine-appliance-*.ova
      register: ova_result
    - name: Create target directory for answer file
      file:
        path: /root/etc
        state: directory
        owner: root
        group: root
        mode: 0755
    - name: Prepare Hosted Engine installation answer file
      template:
        src: templates/he-answers.j2
        dest: /root/etc/he-answers.conf
        owner: root
        group: root
        mode: 0644
    - name: Configure DHCPd reservation for Engine vm
      template:
        src: templates/dhcpd-static-leases.j2
        dest: /etc/dhcp/dhcpd-static-leases.conf
        owner: root
        group: root
        mode: 0644
      delegate_to: localhost
    - name: Apply DHCPd reconfiguration
      systemd:
        name: dhcpd
        state: restarted
      delegate_to: localhost
    - name: Perform actual Hosted Engine setup
      vars:
        ansible_ssh_pipelining: no
      command: hosted-engine --deploy --config-append=/root/etc/he-answers.conf
      register: setup_result
...
